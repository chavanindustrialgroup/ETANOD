<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ETANOD — Polos</title>
  <meta name="description" content="ETANOD luxury polos — premium craftsmanship and timeless silhouettes." />
  <meta name="theme-color" content="#0a0a0a" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#ffffff;
      --ink:#0a0a0a;
      --muted:#6b7280;
      --gold:#d4af37;
      --soft:#f5f5f7;
      --grid-gap:18px;
      --cols:3;
      --card-radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
      line-height:1.45;
    }
    a{color:inherit; text-decoration:none}
    .container{width:min(1200px, 100% - 40px); margin-inline:auto}

    /* NAV */
    header.nav{
      position:sticky; top:0; z-index:60; backdrop-filter:saturate(180%) blur(10px);
      background:rgba(255,255,255,.82); border-bottom:1px solid #eee;
    }
    .nav-inner{display:flex; align-items:center; gap:18px; padding:14px 0}
    .brand{display:flex; align-items:center; gap:12px; font-weight:600}
    .brand img{height:36px; width:auto; object-fit:contain}
    .brand .wordmark{font-family:"Cormorant Garamond",serif; font-size:22px; letter-spacing:.24em}
    .spacer{flex:1}
    .pill{border:1px solid #e5e7eb; border-radius:999px; padding:10px 14px; background:#fff; display:flex; align-items:center; gap:10px}
    .controls{display:flex; gap:10px; flex-wrap:wrap}
    .controls .pill input[type="search"]{border:0; outline:0; width:180px; font:inherit; background:transparent}
    .pill select, .pill button{border:0; background:transparent; font:inherit; color:inherit; cursor:pointer}
    .pill button{padding:0 6px}
    .pill button.active{color:var(--gold); font-weight:600}
    .signin{border:1px solid #e5e7eb; border-radius:999px; padding:10px 14px; background:#111; color:#fff; font-weight:500; cursor:pointer}
    .userchip{display:flex; align-items:center; gap:10px; border:1px solid #e5e7eb; border-radius:999px; padding:6px 10px; background:#fff; cursor:pointer}
    .avatar{width:30px; height:30px; border-radius:999px; display:grid; place-items:center; font-size:12px; font-weight:600; background:linear-gradient(135deg,#111,#333); color:#fff}
    .menu{position:absolute; right:0; margin-top:10px; background:#fff; border:1px solid #eee; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.08); overflow:hidden; display:none; min-width:220px}
    .menu.open{display:block}
    .menu a, .menu button{display:block; width:100%; text-align:left; padding:12px 14px; border:0; background:#fff; cursor:pointer}
    .menu a:hover, .menu button:hover{background:#fafafa}

    main{padding:26px 0 60px}
    #productGrid{display:grid; grid-template-columns: repeat(var(--cols), minmax(0,1fr)); gap:var(--grid-gap); transition:grid-template-columns .25s ease}
    .card{border:1px solid #eee; border-radius:var(--card-radius); overflow:hidden; background:#fff; display:flex; flex-direction:column; position:relative; box-shadow:0 1px 0 rgba(0,0,0,.04)}
    .card .media{aspect-ratio:1/1; background:#f4f4f5; position:relative; overflow:hidden}
    .card img{width:100%; height:100%; object-fit:cover; display:block; transition:transform .45s ease, opacity .3s ease}
    .card:hover img.primary{opacity:0}
    .card:hover img.secondary{opacity:1; transform:scale(1.02)}
    .card img.secondary{position:absolute; inset:0; opacity:0}
    .badge{position:absolute; left:12px; top:12px; font-size:12px; padding:6px 10px; border-radius:999px; background:#111; color:#fff; letter-spacing:.06em}
    .wishlist{position:absolute; right:10px; top:10px; background:#fff; border:1px solid #e5e7eb; width:36px; height:36px; border-radius:999px; display:grid; place-items:center; cursor:pointer}
    .wishlist svg{width:18px; height:18px}
    .wishlist.active{border-color:var(--gold); box-shadow:0 0 0 2px rgba(212,175,55,.15)}
    .meta{padding:14px 14px 16px}
    .title{font-size:14px; font-weight:500; letter-spacing:.02em}
    .subtitle{font-size:12px; color:var(--muted); margin-top:4px}
    .price{margin-top:8px; font-weight:600}
    footer{border-top:1px solid #eee; padding:24px 0; color:#6b7280}

    /* Product Modal */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; place-items:center; z-index:50}
    .modal.open{display:grid}
    .dialog{width:min(1100px,96vw); background:#fff; border-radius:20px; overflow:hidden; display:grid; grid-template-columns:1fr 380px; gap:0; max-height:90vh}
    .dialog .gallery{background:#fafafa; padding:16px; overflow:auto}
    .dialog .details{padding:20px 22px; overflow:auto}
    .gallery-main{position:relative}
    .gallery-main img{width:100%; height:auto; display:block; border-radius:14px}
    .thumbs{display:grid; grid-template-columns:repeat(5,1fr); gap:10px; margin-top:12px}
    .thumbs button{border:1px solid transparent; padding:0; border-radius:10px; overflow:hidden; background:#fff; cursor:pointer}
    .thumbs button.active{border-color:var(--gold)}
    .thumbs img{display:block; width:100%; height:auto}
    .dialog .close{position:absolute; right:12px; top:12px; width:40px; height:40px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; display:grid; place-items:center; cursor:pointer}
    .dialog-wrap{position:relative}
    .arrows{position:absolute; inset:0; display:flex; align-items:center; justify-content:space-between; pointer-events:none}
    .arrows button{pointer-events:auto; width:42px; height:42px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; cursor:pointer}

    /* AUTH MODAL */
    .auth-modal{position:fixed; inset:0; display:none; place-items:center; z-index:80; background:rgba(0,0,0,.55);}
    .auth-modal.open{display:grid}
    .auth-card{width:min(560px,94vw); background:rgba(255,255,255,.9); backdrop-filter: blur(12px) saturate(140%); border:1px solid rgba(0,0,0,.06); border-radius:22px; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,.14)}
    .auth-head{display:flex; align-items:center; justify-content:space-between; padding:18px 18px; border-bottom:1px solid #eee}
    .auth-title{font-family:"Cormorant Garamond",serif; letter-spacing:.1em; font-size:20px}
    .auth-close{width:38px; height:38px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; display:grid; place-items:center; cursor:pointer}
    .auth-body{padding:18px}
    .seg{display:flex; gap:8px; background:#f3f4f6; padding:6px; border-radius:999px; margin-bottom:14px}
    .seg button{flex:1; padding:10px 12px; border-radius:999px; border:0; background:transparent; cursor:pointer; font-weight:500}
    .seg button.active{background:#fff; box-shadow:0 1px 0 rgba(0,0,0,.06); border:1px solid #eee}
    .field{display:flex; flex-direction:column; gap:6px; margin:10px 0}
    .field label{font-size:12px; color:var(--muted)}
    .field input{border:1px solid #e5e7eb; border-radius:12px; padding:12px 12px; font:inherit}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:12px 14px; border-radius:999px; border:1px solid #111; background:#111; color:#fff; cursor:pointer; font-weight:600}
    .btn.secondary{border-color:#e5e7eb; background:#fff; color:#111}
    .hint{font-size:12px; color:#6b7280}
    .otp{display:flex; gap:8px; margin:10px 0}
    .otp input{width:44px; height:52px; border:1px solid #e5e7eb; border-radius:12px; text-align:center; font-size:18px}
    .note{background:linear-gradient(180deg,#fff, #faf7ef); border:1px solid #f1e9cf; color:#7a6a2c; padding:10px 12px; border-radius:12px; font-size:12px; margin-top:10px}

    @media (max-width: 960px){ :root{ --cols:2 } .dialog{grid-template-columns:1fr} }
    @media (max-width: 640px){ :root{ --cols:2; --grid-gap:14px } .controls .pill input[type="search"]{width:120px} }
  </style>
</head>
<body>
  <header class="nav">
    <div class="container nav-inner">
      <a class="brand" href="#">
        <img id="logo" src="IMAGES/LOGO/LOGO.png" alt="ETANOD logo" onerror="this.onerror=null; this.src='IMAGES/LOGO/L1.png'; this.alt='ETANOD';">
        <span class="wordmark">ETANOD</span>
      </a>
      <div class="spacer"></div>
      <div class="controls">
        <div class="pill"><input id="search" type="search" placeholder="Search polos…" aria-label="Search products"/></div>
        <div class="pill">
          <label for="sort" style="color:#6b7280">Sort</label>
          <select id="sort" aria-label="Sort products">
            <option value="new">Newest</option>
            <option value="id-asc">ID (1 → 30)</option>
            <option value="id-desc">ID (30 → 1)</option>
            <option value="name-asc">Name (A → Z)</option>
            <option value="name-desc">Name (Z → A)</option>
          </select>
        </div>
        <div class="pill" role="group" aria-label="Grid columns">
          <button data-cols="2">2</button>
          <button class="active" data-cols="3">3</button>
          <button data-cols="4">4</button>
        </div>
        <button id="signInBtn" class="signin">Sign in</button>
        <div id="userWrap" style="position:relative; display:none">
          <div id="userChip" class="userchip" aria-haspopup="menu" aria-expanded="false">
            <div id="avatar" class="avatar">E</div>
            <div id="chipEmail" class="hint">user@domain</div>
          </div>
          <div id="userMenu" class="menu" role="menu" aria-label="Account">
            <a href="#" id="viewAccount">Account</a>
            <a href="#" id="viewWishlist">Wishlist</a>
            <button id="signOut">Sign out</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <div style="display:flex; align-items:baseline; justify-content:space-between; gap:12px; margin:6px 2px 18px;">
      <h1 style="font-family:'Cormorant Garamond',serif; letter-spacing:.1em; font-weight:500; margin:0; font-size:28px">Polos</h1>
      <div id="count" style="color:#6b7280; font-size:14px"></div>
    </div>
    <section id="productGrid" aria-live="polite"></section>
  </main>

  <footer>
    <div class="container" style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px">
      <div>© <span id="year"></span> ETANOD. All rights reserved.</div>
      <div>Crafted with care • Pune, IN</div>
    </div>
  </footer>

  <!-- Product Modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-label="Product details">
      <div class="gallery dialog-wrap">
        <button class="close" aria-label="Close" onclick="closeModal()">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18M6 6l12 12"></path></svg>
        </button>
        <div class="gallery-main">
          <img id="mainImage" alt="Product image">
          <div class="arrows">
            <button aria-label="Previous image" onclick="prevImage()">‹</button>
            <button aria-label="Next image" onclick="nextImage()">›</button>
          </div>
        </div>
        <div class="thumbs" id="thumbs"></div>
      </div>
      <div class="details">
        <h2 id="modalTitle" style="margin:.25rem 0 .5rem; font-size:22px">Product</h2>
        <div id="modalSubtitle" class="subtitle">Classic Polo</div>
        <div class="price" id="modalPrice" style="margin:14px 0 18px;">&nbsp;</div>
        <p style="font-size:14px; color:#444; margin:0 0 16px;">Premium cotton pique polo. Five-view gallery (front, 3/4, side, 3/4, back). Designed by ETANOD.</p>
        <div style="display:flex; gap:10px; align-items:center; margin-top:16px">
          <button style="padding:12px 16px; border-radius:999px; border:1px solid #111; background:#111; color:#fff; cursor:pointer">Add to Bag</button>
          <button style="padding:12px 16px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; cursor:pointer">Wishlist</button>
        </div>
      </div>
    </div>
  </div>

  <!-- AUTH MODAL -->
  <div id="authModal" class="auth-modal" aria-hidden="true">
    <div class="auth-card" role="dialog" aria-modal="true" aria-label="Sign in">
      <div class="auth-head">
        <div class="auth-title">Sign in to ETANOD</div>
        <button class="auth-close" aria-label="Close" id="authClose">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18M6 6l12 12"></path></svg>
        </button>
      </div>
      <div class="auth-body">
        <div class="seg" role="tablist">
          <button id="tabEmail" class="active" role="tab" aria-selected="true">Email</button>
          <button id="tabPhone" role="tab" aria-selected="false">Phone</button>
        </div>
        <div id="emailPane">
          <div class="field"><label for="email">Email</label><input id="email" type="email" placeholder="you@domain.com" autocomplete="email"/></div>
          <button id="sendEmailOtp" class="btn">Send OTP</button>
          <div class="hint" style="margin-top:8px">We’ll email a 6‑digit code. No password needed.</div>
          <div id="emailOtpWrap" style="display:none">
            <div class="field" style="margin-top:14px"><label>Enter OTP</label>
              <div class="otp" id="emailOtpBoxes"></div>
            </div>
            <button id="verifyEmailOtp" class="btn">Verify & Continue</button>
          </div>
          <div class="note">If your project is set to magic link instead of OTP, you’ll receive a link instead of a code.</div>
        </div>
        <div id="phonePane" style="display:none">
          <div class="field"><label for="phone">Phone</label><input id="phone" type="tel" placeholder="+91 98765 43210" autocomplete="tel"/></div>
          <button id="sendSmsOtp" class="btn">Send OTP</button>
          <div class="hint" style="margin-top:8px">We’ll text a 6‑digit code to your phone.</div>
          <div id="smsOtpWrap" style="display:none">
            <div class="field" style="margin-top:14px"><label>Enter OTP</label>
              <div class="otp" id="smsOtpBoxes"></div>
            </div>
            <button id="verifySmsOtp" class="btn">Verify & Continue</button>
          </div>
          <div class="note">SMS requires configuring a provider (e.g., Twilio/Vonage) in your backend.</div>
        </div>
        <div id="authMsg" class="hint" style="margin-top:12px"></div>
      </div>
    </div>
  </div>

  <!-- ====================
       DATABASE & AUTH (Supabase)
       ====================
       1) Create a free Supabase project → Settings → URL & anon key.
       2) Auth → Providers: enable Email OTP and/or Phone (SMS) as desired.
       3) SQL → Run once:

       -- profiles
       create table if not exists public.profiles (
         id uuid primary key references auth.users(id) on delete cascade,
         email text,
         phone text,
         full_name text,
         created_at timestamptz default now()
       );
       alter table public.profiles enable row level security;
       create policy if not exists "profile self access" on public.profiles
       for select using (auth.uid() = id);
       create policy if not exists "profile upsert self" on public.profiles
       for insert with check (auth.uid() = id);
       create policy if not exists "profile update self" on public.profiles
       for update using (auth.uid() = id);

       -- wishlist
       create table if not exists public.wishlist (
         id bigserial primary key,
         user_id uuid references auth.users(id) on delete cascade,
         product_id int not null,
         created_at timestamptz default now(),
         unique (user_id, product_id)
       );
       alter table public.wishlist enable row level security;
       create policy if not exists "wishlist self" on public.wishlist
       for all using (auth.uid() = user_id) with check (auth.uid() = user_id);
  -->

  <script type="module">
    // --- Import Supabase ---
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // TODO: replace with your Supabase values
    const SUPABASE_URL = 'https://YOUR-PROJECT.supabase.co';
    const SUPABASE_ANON_KEY = 'YOUR-ANON-KEY';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---------- Catalog ----------
    const PRODUCTS = Array.from({length: 30}, (_, i) => {
      const id = i + 1;
      return { id, title: `Classic Polo ${String(id).padStart(2,'0')}`, subtitle: 'ETANOD Essentials', price: '', badge: id <= 6 ? 'NEW' : '' };
    });

    // ---------- Elements ----------
    const grid = document.getElementById('productGrid');
    const countEl = document.getElementById('count');
    const searchEl = document.getElementById('search');
    const sortEl = document.getElementById('sort');
    const colBtns = [...document.querySelectorAll('[data-cols]')];
    const state = { query: '', sort: 'new', cols: 3 };

    const imgPath = (id, idx, ext='png') => `IMAGES/${id}/${id}.${idx}.${ext}`;
    const withFallback = (img, id, idx) => { img.onerror = () => { if(!img.dataset.triedJpg){ img.src = imgPath(id, idx, 'jpg'); img.dataset.triedJpg = 1; } }; };

    // ---------- Rendering ----------
    function render(){
      const q = state.query.trim().toLowerCase();
      let items = PRODUCTS.filter(p => p.title.toLowerCase().includes(q));
      switch(state.sort){
        case 'id-asc': items.sort((a,b)=>a.id-b.id); break;
        case 'id-desc': items.sort((a,b)=>b.id-a.id); break;
        case 'name-asc': items.sort((a,b)=>a.title.localeCompare(b.title)); break;
        case 'name-desc': items.sort((a,b)=>b.title.localeCompare(a.title)); break;
        default: items.sort((a,b)=>b.id-a.id); // newest first
      }
      grid.style.setProperty('--cols', state.cols);
      grid.innerHTML = '';
      for(const p of items){
        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          <div class="media" role="button" aria-label="${p.title}" tabindex="0">
            ${p.badge ? `<div class="badge">${p.badge}</div>` : ''}
            <button class="wishlist" title="Wishlist" aria-label="Wishlist" data-id="${p.id}">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
            </button>
            <img class="primary" alt="${p.title} front view" loading="lazy">
            <img class="secondary" alt="${p.title} alternate view" loading="lazy">
          </div>
          <div class="meta">
            <div class="title">${p.title}</div>
            <div class="subtitle">${p.subtitle}</div>
            ${p.price ? `<div class="price">₹${p.price}</div>` : ''}
          </div>`;
        const primary = card.querySelector('img.primary');
        const secondary = card.querySelector('img.secondary');
        primary.src = imgPath(p.id, 1); withFallback(primary, p.id, 1);
        secondary.src = imgPath(p.id, 2); withFallback(secondary, p.id, 2);
        const media = card.querySelector('.media');
        media.addEventListener('click', ()=>openModal(p.id, p.title, p.subtitle, p.price));
        media.addEventListener('keypress', (e)=>{ if(e.key==='Enter') openModal(p.id, p.title, p.subtitle, p.price) });
        // wishlist click
        const wishBtn = card.querySelector('.wishlist');
        wishBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleWishlist(p.id, wishBtn); });
        grid.appendChild(card);
      }
      countEl.textContent = `${items.length} products`;
      preloadWishlistState();
    }

    searchEl.addEventListener('input', e => { state.query = e.target.value; render(); });
    sortEl.addEventListener('change', e => { state.sort = e.target.value; render(); });
    colBtns.forEach(btn => btn.addEventListener('click', ()=>{ state.cols = Number(btn.dataset.cols); colBtns.forEach(b => b.classList.toggle('active', b===btn)); render(); }));

    // ---------- Product Modal (global funcs) ----------
    window.modal = document.getElementById('modal');
    window.mainImage = document.getElementById('mainImage');
    window.thumbs = document.getElementById('thumbs');
    window.modalTitle = document.getElementById('modalTitle');
    window.modalSubtitle = document.getElementById('modalSubtitle');
    window.modalPrice = document.getElementById('modalPrice');
    let current = { id:1, idx:1 };
    window.openModal = (id, title, subtitle, price)=>{
      current.id = id; current.idx = 1;
      modalTitle.textContent = title; modalSubtitle.textContent = subtitle || ''; modalPrice.textContent = price ? `₹${price}` : '';
      thumbs.innerHTML = '';
      for(let i=1;i<=5;i++){
        const btn = document.createElement('button');
        const timg = document.createElement('img');
        timg.alt = `${title} view ${i}`; timg.src = imgPath(id,i); withFallback(timg,id,i);
        btn.appendChild(timg); if(i===1) btn.classList.add('active'); btn.addEventListener('click', ()=>showImage(i)); thumbs.appendChild(btn);
      }
      showImage(1); modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; window.addEventListener('keydown', onKey); modal.addEventListener('click', onBackdrop);
    };
    const onBackdrop = (e)=>{ if(e.target===modal) closeModal(); };
    const onKey = (e)=>{ if(e.key==='Escape') closeModal(); if(e.key==='ArrowRight') nextImage(); if(e.key==='ArrowLeft') prevImage(); };
    window.closeModal = ()=>{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); document.body.style.overflow=''; window.removeEventListener('keydown', onKey); modal.removeEventListener('click', onBackdrop); };
    window.showImage = (idx)=>{ current.idx = idx; mainImage.src = imgPath(current.id, idx); mainImage.alt = `${modalTitle.textContent} view ${idx}`; withFallback(mainImage,current.id,idx); [...thumbs.children].forEach((b,i)=>b.classList.toggle('active', i===idx-1)); };
    window.nextImage = ()=> showImage( current.idx === 5 ? 1 : current.idx + 1 );
    window.prevImage = ()=> showImage( current.idx === 1 ? 5 : current.idx - 1 );

    // Footer year
    document.getElementById('year').textContent = new Date().getFullYear();

    // ---------- AUTH UI logic ----------
    const authModal = document.getElementById('authModal');
    const authClose = document.getElementById('authClose');
    const signInBtn = document.getElementById('signInBtn');
    const tabEmail = document.getElementById('tabEmail');
    const tabPhone = document.getElementById('tabPhone');
    const emailPane = document.getElementById('emailPane');
    const phonePane = document.getElementById('phonePane');
    const emailInput = document.getElementById('email');
    const phoneInput = document.getElementById('phone');
    const sendEmailOtpBtn = document.getElementById('sendEmailOtp');
    const sendSmsOtpBtn = document.getElementById('sendSmsOtp');
    const emailOtpWrap = document.getElementById('emailOtpWrap');
    const smsOtpWrap = document.getElementById('smsOtpWrap');
    const emailOtpBoxes = document.getElementById('emailOtpBoxes');
    const smsOtpBoxes = document.getElementById('smsOtpBoxes');
    const verifyEmailOtpBtn = document.getElementById('verifyEmailOtp');
    const verifySmsOtpBtn = document.getElementById('verifySmsOtp');
    const authMsg = document.getElementById('authMsg');

    const openAuth = ()=>{ authModal.classList.add('open'); authModal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; };
    const closeAuth = ()=>{ authModal.classList.remove('open'); authModal.setAttribute('aria-hidden','true'); document.body.style.overflow=''; authMsg.textContent=''; };

    signInBtn.addEventListener('click', openAuth);
    authClose.addEventListener('click', closeAuth);
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && authModal.classList.contains('open')) closeAuth(); });
    authModal.addEventListener('click', (e)=>{ if(e.target===authModal) closeAuth(); });

    const setTab = (which)=>{
      const isEmail = which==='email';
      tabEmail.classList.toggle('active', isEmail); tabEmail.setAttribute('aria-selected', String(isEmail));
      tabPhone.classList.toggle('active', !isEmail); tabPhone.setAttribute('aria-selected', String(!isEmail));
      emailPane.style.display = isEmail ? '' : 'none';
      phonePane.style.display = isEmail ? 'none' : '';
    };
    tabEmail.addEventListener('click', ()=>setTab('email'));
    tabPhone.addEventListener('click', ()=>setTab('phone'));

    // Build 6 small inputs
    const buildOtp = (wrap)=>{
      wrap.innerHTML = '';
      const boxes = [];
      for(let i=0;i<6;i++){
        const box = document.createElement('input'); box.maxLength = 1; box.inputMode = 'numeric'; box.pattern='[0-9]*';
        box.addEventListener('input', ()=>{ box.value = box.value.replace(/\D/g,''); if(box.value && i<5) boxes[i+1].focus(); });
        box.addEventListener('keydown', (e)=>{ if(e.key==='Backspace' && !box.value && i>0) boxes[i-1].focus(); });
        boxes.push(box); wrap.appendChild(box);
      }
      return boxes;
    };
    let emailBoxes = buildOtp(emailOtpBoxes);
    let smsBoxes = buildOtp(smsOtpBoxes);

    const readOtp = (boxes)=> boxes.map(b=>b.value.trim()).join('');

    // --- Send Email OTP ---
    sendEmailOtpBtn.addEventListener('click', async ()=>{
      const email = emailInput.value.trim(); if(!email){ authMsg.textContent='Enter a valid email.'; return; }
      authMsg.textContent = 'Sending code…';
      const { error } = await supabase.auth.signInWithOtp({ email, options: { shouldCreateUser: true } });
      if(error){ authMsg.textContent = `Error: ${error.message}`; return; }
      authMsg.textContent = 'OTP sent to your email.'; emailOtpWrap.style.display=''; emailBoxes[0].focus();
    });

    // --- Verify Email OTP ---
    verifyEmailOtpBtn.addEventListener('click', async ()=>{
      const email = emailInput.value.trim(); const token = readOtp(emailBoxes);
      if(token.length!==6){ authMsg.textContent = 'Enter the 6‑digit code.'; return; }
      authMsg.textContent = 'Verifying…';
      const { data, error } = await supabase.auth.verifyOtp({ email, token, type: 'email' });
      if(error){ authMsg.textContent = `Error: ${error.message}`; return; }
      await postLoginBootstrap(); closeAuth();
    });

    // --- Send SMS OTP ---
    sendSmsOtpBtn.addEventListener('click', async ()=>{
      let phone = phoneInput.value.replace(/\s+/g,'');
      if(!phone.startsWith('+')){ authMsg.textContent='Use E.164 format (e.g., +91XXXXXXXXXX).'; return; }
      authMsg.textContent = 'Sending SMS…';
      const { error } = await supabase.auth.signInWithOtp({ phone, options: { channel:'sms', shouldCreateUser: true } });
      if(error){ authMsg.textContent = `Error: ${error.message}`; return; }
      authMsg.textContent = 'OTP sent via SMS.'; smsOtpWrap.style.display=''; smsBoxes[0].focus();
    });

    // --- Verify SMS OTP ---
    verifySmsOtpBtn.addEventListener('click', async ()=>{
      let phone = phoneInput.value.replace(/\s+/g,'');
      const token = readOtp(smsBoxes);
      if(token.length!==6){ authMsg.textContent='Enter the 6‑digit code.'; return; }
      authMsg.textContent = 'Verifying…';
      const { error } = await supabase.auth.verifyOtp({ phone, token, type:'sms' });
      if(error){ authMsg.textContent = `Error: ${error.message}`; return; }
      await postLoginBootstrap(); closeAuth();
    });

    // --- After login: create profile if missing, update header, preload wishlist ---
    async function postLoginBootstrap(){
      const { data: { user } } = await supabase.auth.getUser();
      if(user){
        const email = user.email ?? null; const phone = user.phone ?? null;
        await supabase.from('profiles').upsert({ id: user.id, email, phone }, { onConflict: 'id' });
        showUser(user);
        await loadWishlist();
        preloadWishlistState();
      }
    }

    // --- Header user chip & menu ---
    const userWrap = document.getElementById('userWrap');
    const userChip = document.getElementById('userChip');
    const chipEmail = document.getElementById('chipEmail');
    const avatar = document.getElementById('avatar');
    const userMenu = document.getElementById('userMenu');
    const signOutBtn = document.getElementById('signOut');

    function initialsFrom(str){
      if(!str) return 'E';
      const parts = str.split(/[@\s\.\_\-]+/).filter(Boolean);
      const a = (parts[0]?.[0]||'E').toUpperCase();
      const b = (parts[1]?.[0]||'T').toUpperCase();
      return a+b;
    }

    function showUser(user){
      signInBtn.style.display='none'; userWrap.style.display='block';
      const label = user.email || user.phone || 'Account';
      chipEmail.textContent = label; avatar.textContent = initialsFrom(label);
    }

    function hideUser(){ signInBtn.style.display=''; userWrap.style.display='none'; }

    userChip.addEventListener('click', ()=>{ const open = userMenu.classList.toggle('open'); userChip.setAttribute('aria-expanded', String(open)); });
    document.addEventListener('click', (e)=>{ if(!userWrap.contains(e.target)) { userMenu.classList.remove('open'); userChip.setAttribute('aria-expanded','false'); }});

    signOutBtn.addEventListener('click', async ()=>{ await supabase.auth.signOut(); hideUser(); wishlist = new Set(); preloadWishlistState(); });

    // --- Session on load ---
    const { data: sessionData } = await supabase.auth.getSession();
    if(sessionData?.session?.user){ showUser(sessionData.session.user); await loadWishlist(); }

    // Keep in sync
    supabase.auth.onAuthStateChange((_event, session)=>{ if(session?.user){ showUser(session.user); } else { hideUser(); } });

    // ---------- Wishlist (DB-backed) ----------
    let wishlist = new Set();

    async function loadWishlist(){
      const { data, error } = await supabase.from('wishlist').select('product_id');
      if(!error && data){ wishlist = new Set(data.map(r=>r.product_id)); }
    }

    async function toggleWishlist(productId, btn){
      const { data: { user } } = await supabase.auth.getUser();
      if(!user){ openAuth(); return; }
      if(wishlist.has(productId)){
        const { error } = await supabase.from('wishlist').delete().match({ product_id: productId });
        if(!error){ wishlist.delete(productId); btn.classList.remove('active'); }
      } else {
        const { error } = await supabase.from('wishlist').upsert({ product_id: productId });
        if(!error){ wishlist.add(productId); btn.classList.add('active'); }
      }
    }

    function preloadWishlistState(){
      document.querySelectorAll('.wishlist').forEach(btn=>{
        const id = Number(btn.dataset.id); btn.classList.toggle('active', wishlist.has(id));
      });
    }

    // ---------- Boot ----------
    render();
  </script>
</body>
</html>